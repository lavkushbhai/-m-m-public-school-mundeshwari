<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Signup</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(135deg,#e3f2fd,#ede7f6);
  display:flex;
  align-items:center;
  justify-content:center;
}
.container{
  background:#fff;
  width:92%;
  max-width:420px;
  border-radius:24px;
  padding:26px;
  box-shadow:0 30px 70px rgba(0,0,0,.35);
}
h2{text-align:center;color:#1e3c72;margin-bottom:18px}
.step{display:none}
.step.active{display:block}

input{
  width:100%;
  padding:14px 16px;
  border-radius:14px;
  border:1.5px solid #d0d7e2;
  font-size:14px;
  margin-bottom:14px;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:linear-gradient(135deg,#1e3c72,#4a6fff);
  color:#fff;
  font-weight:900;
  font-size:15px;
  cursor:pointer;
}

.input-wrap{position:relative}
.eye{
  position:absolute;
  right:16px;
  top:50%;
  transform:translateY(-50%);
  color:#555;
  cursor:pointer;
}

.check{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:13px;
  margin-bottom:14px;
}

/* PREVIEW */
.preview{display:grid;gap:14px}
.p-box{
  background:#f6f8ff;
  padding:14px 16px;
  border-radius:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.15);
}

/* SUCCESS */
.success{
  animation:pop .6s cubic-bezier(.16,1,.3,1);
}
@keyframes pop{
  from{opacity:0;transform:scale(.85)}
  to{opacity:1;transform:scale(1)}
}
.sid{
  font-size:20px;
  font-weight:900;
  color:#2e7d32;
}
.btn-row{
  display:flex;
  gap:12px;
  margin-top:16px;
}
.btn-row button{flex:1}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.popup-box{
  background:#fff;
  width:90%;
  max-width:340px;
  padding:24px;
  border-radius:22px;
  text-align:center;
  box-shadow:0 25px 60px rgba(0,0,0,.45);
}

/* LOADING */
.spinner{
  width:44px;
  height:44px;
  border:4px solid #ddd;
  border-top:4px solid #1e3c72;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 10px;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div class="container">

<!-- STEP 1 -->
<div class="step active" id="step1">
  <h2>Student Name</h2>
  <input id="studentName" placeholder="Enter student name">
  <button onclick="nextStep(1)">Next</button>
</div>

<!-- STEP 2 -->
<div class="step" id="step2">
  <h2>Account Details</h2>

  <input id="username" placeholder="Username">
  <input id="confirmUsername" placeholder="Confirm Username">

  <div class="input-wrap">
    <input id="password" type="password" placeholder="Password">
  </div>

  <div class="input-wrap">
    <input id="confirmPassword" type="password" placeholder="Confirm Password">
    <i class="fa-solid fa-eye eye" onclick="togglePass()"></i>
  </div>

  <div class="check">
    <input type="checkbox" id="matchCheck" disabled>
    <label>Username & Password Match</label>
  </div>

  <button onclick="nextStep(2)">Next</button>
</div>

<!-- STEP 3 PREVIEW -->
<div class="step" id="step3">
  <h2>Preview</h2>
  <div class="preview">
    <div class="p-box"><b>Name:</b> <span id="pName"></span></div>
    <div class="p-box"><b>Username:</b> <span id="pUser"></span></div>
    <div class="p-box"><b>Password:</b> <span id="pPass"></span></div>
    <div class="p-box"><b>Signup Time:</b> <span id="pTime"></span></div>
  </div>
  <button onclick="previewNext()">Next</button>
</div>

<!-- STEP 4 SUCCESS -->
<div class="step success" id="step4">
  <h2 style="color:#2e7d32">Signup Successful</h2>

  <div class="preview">
    <div class="p-box" style="text-align:center">
      <b>Your School ID</b><br>
      <div class="sid" id="schoolId"></div>
    </div>
  </div>

  <div class="btn-row">
    <button onclick="copyId()">Copy ID</button>
    <button onclick="confirmSave()">Confirm</button>
  </div>
</div>

</div>

<!-- ALERT -->
<div class="popup" id="alertPopup">
  <div class="popup-box">
    <p id="alertText"></p>
    <button onclick="closeAlert()">OK</button>
  </div>
</div>

<!-- LOADING -->
<div class="popup" id="loadingPopup">
  <div class="popup-box">
    <div class="spinner"></div>
    <p>Please wait...</p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, set, get, child }
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyCy1r8BXbe-W9UBsCrFDFgkHy-j7lYFwYg",
  databaseURL:"https://mmpublicschoolmundeshwar-233a4-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);

let signupTime="";

/* ALERT */
function showAlert(msg){
  alertText.innerText = msg;
  alertPopup.style.display="flex";
}
function closeAlert(){
  alertPopup.style.display="none";
}

/* STEP */
function nextStep(step){
  if(step===1 && !studentName.value.trim()){
    showAlert("Student name required");
    return;
  }

  if(step===2){
    if(!matchCheck.checked){
      showAlert("Username / Password not matched");
      return;
    }
    signupTime=new Date().toLocaleTimeString();
    pName.innerText=studentName.value;
    pUser.innerText=username.value;
    pPass.innerText=password.value;
    pTime.innerText=signupTime;
  }

  document.getElementById("step"+step).classList.remove("active");
  document.getElementById("step"+(step+1)).classList.add("active");
}

/* MATCH */
function checkMatch(){
  matchCheck.checked =
    username.value &&
    username.value===confirmUsername.value &&
    password.value &&
    password.value===confirmPassword.value;
}
username.oninput=checkMatch;
confirmUsername.oninput=checkMatch;
password.oninput=checkMatch;
confirmPassword.oninput=checkMatch;

/* TOGGLE */
function togglePass(){
  confirmPassword.type =
    confirmPassword.type==="password"?"text":"password";
}

/* âœ… UPDATED SCHOOL ID LOGIC (REUSE DELETED ID) */
async function generateSchoolId(){
  const year=new Date().getFullYear();
  const prefix=`MMPSM-${year}-`;

  const snap=await get(child(ref(db),"students"));
  let used=[];

  if(snap.exists()){
    Object.keys(snap.val()).forEach(id=>{
      if(id.startsWith(prefix)){
        const n=parseInt(id.split("-").pop(),10);
        if(!isNaN(n)) used.push(n);
      }
    });
  }

  let next=1;
  while(used.includes(next)) next++;

  return prefix + String(next).padStart(2,"0");
}

/* PREVIEW NEXT */
async function previewNext(){
  loadingPopup.style.display="flex";
  setTimeout(async()=>{
    loadingPopup.style.display="none";
    const id=await generateSchoolId();
    schoolId.innerText=id;
    step3.classList.remove("active");
    step4.classList.add("active");
  },3000);
}

/* COPY */
function copyId(){
  navigator.clipboard.writeText(schoolId.innerText);
}

/* CONFIRM */
async function confirmSave(){
  loadingPopup.style.display="flex";

  await set(ref(db,"students/"+schoolId.innerText),{
    name:studentName.value,
    username:username.value,
    password:password.value,
    time:signupTime,
    schoolId:schoolId.innerText
  });

  setTimeout(()=>window.location.href="index.html",2000);
}

/* expose */
window.nextStep=nextStep;
window.previewNext=previewNext;
window.togglePass=togglePass;
window.copyId=copyId;
window.confirmSave=confirmSave;
window.closeAlert=closeAlert;
</script>

</body>
</html>